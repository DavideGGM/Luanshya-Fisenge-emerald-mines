<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LUANSHYA — Viewer interattivo</title>

<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

<style>
  body {
    margin:0;
    font-family: system-ui, sans-serif;
  }

  /* Layout desktop */
  .container {
    display:grid;
    grid-template-columns:480px 1fr;
    height:100vh;
  }

  #left {
    border-right:1px solid #ddd;
    padding:12px;
    overflow:auto;
    background:white;
  }

  #api-frame {
    width:100%;
    height:100%;
    border:0;
    min-height:300px;
  }

  /* Mobile layout */
  @media (max-width: 900px) {
    .container {
      grid-template-columns:1fr;
      grid-template-rows:60vh auto;
      height:100vh;
    }
    #api-frame {
      height:60vh;
      min-height:60vh;
    }
    #left {
      border-right:none;
      border-top:1px solid #ddd;
      max-height:40vh;
    }
  }

  .topline{display:flex;justify-content:space-between;gap:10px;}
  #status{font-size:13px;opacity:.7;}
  .topbar{display:flex;gap:8px;margin:10px 0 12px;}
  .topbar button{flex:1;padding:10px;cursor:pointer;}
  .row{display:grid;grid-template-columns:1fr 95px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0;}
  .name{font-size:13px;}
  .id{font-size:11px;opacity:.6;}
  .toggle{padding:8px 10px;font-weight:800;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;}
  .toggle.off{opacity:.55;}
</style>
</head>

<body>

<div class="container">

  <div id="left">
    <div class="topline">
      <b>LUANSHYA – Controllo Modello</b>
      <div id="status">Inizializzo…</div>
    </div>

    <div class="topbar">
      <button id="showAll" disabled>Mostra tutto</button>
      <button id="hideAll" disabled>Nascondi tutto</button>
    </div>

    <div id="list"></div>
  </div>

  <iframe id="api-frame"
    title="LUANSHYA"
    allow="autoplay; fullscreen; xr-spatial-tracking"
    xr-spatial-tracking
    execution-while-out-of-viewport
    execution-while-not-rendered
    web-share
    allowfullscreen
    src="https://sketchfab.com/models/8a3b7c65c4d6495ba888a91ca768555d/embed">
  </iframe>

</div>

<script>
const MODEL_UID = "8a3b7c65c4d6495ba888a91ca768555d";

const iframe = document.getElementById("api-frame");
const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const btnShowAll = document.getElementById("showAll");
const btnHideAll = document.getElementById("hideAll");

const client = new Sketchfab(iframe);
let apiRef = null;
let groups = [];
const groupVisible = new Map();

function setState(name, visible, btn){
  groupVisible.set(name, visible);
  if(visible){btn.textContent="ON";btn.classList.remove("off");}
  else{btn.textContent="OFF";btn.classList.add("off");}
}

function apply(ids, show){
  ids.forEach(id => show ? apiRef.show(id) : apiRef.hide(id));
}

function buildList(){
  listEl.innerHTML="";
  groups.forEach(g=>{
    const row=document.createElement("div");
    row.className="row";

    const left=document.createElement("div");
    left.className="name";
    left.innerHTML=`<div>${g.name}</div><div class="id">geometrie: ${g.ids.length}</div>`;

    const btn=document.createElement("button");
    btn.className="toggle";
    btn.onclick=()=>{
      const v = groupVisible.get(g.name);
      apply(g.ids, !v);
      setState(g.name,!v,btn);
    };

    setState(g.name,true,btn);

    row.appendChild(left);
    row.appendChild(btn);
    listEl.appendChild(row);
  });

  statusEl.textContent="Viewer pronto ✅";
  btnShowAll.disabled=false;
  btnHideAll.disabled=false;
}

btnShowAll.onclick=()=>{
  groups.forEach(g=>apply(g.ids,true));
  document.querySelectorAll(".toggle").forEach((b,i)=>{
    setState(groups[i].name,true,b);
  });
};

btnHideAll.onclick=()=>{
  groups.forEach(g=>apply(g.ids,false));
  document.querySelectorAll(".toggle").forEach((b,i)=>{
    setState(groups[i].name,false,b);
  });
};

// -------- SceneGraph logic --------
function walk(n,fn){fn(n);(n.children||[]).forEach(c=>walk(c,fn));}
function isGeom(n){return String(n.type||"").toLowerCase().includes("geometry");}
function collectGeom(n){
  const s=new Set();
  walk(n,x=>{if(isGeom(x)&&x.instanceID!==undefined)s.add(x.instanceID)});
  return s;
}
function findByPrefix(scene,p){
  const out=[];
  walk(scene,n=>{if(n.name && n.name.startsWith(p)) out.push(n)});
  return out;
}
function findByName(scene,name){
  const out=[];
  walk(scene,n=>{if(n.name===name) out.push(n)});
  return out;
}
function setToArr(s){return [...s];}
function diff(a,b){const o=new Set();a.forEach(v=>{if(!b.has(v))o.add(v)});return o;}
function union(arr){const u=new Set();arr.forEach(s=>s.forEach(v=>u.add(v)));return u;}

client.init(MODEL_UID,{
  autostart:1,
  preload:1,
  success:function(api){
    apiRef=api;
    api.addEventListener("viewerready",()=>{
      api.getSceneGraph((err,scene)=>{
        if(err){statusEl.textContent="Errore ❌";return;}

        // Resistivity geometries
        const resNodes=findByPrefix(scene,"Resistivity");
        const resGeom=union(resNodes.map(n=>collectGeom(n)));

        // DTM geometries (from DTM or DTM_21)
        const dtmNodes = findByName(scene,"DTM_21").length ? 
                         findByName(scene,"DTM_21") : findByName(scene,"DTM");
        const dtmGeomAll=union(dtmNodes.map(n=>collectGeom(n)));
        const dtmGeomOnly=diff(dtmGeomAll,resGeom);

        // Build groups
        groups=[];

        // DTM safe
        if(dtmGeomOnly.size>0){
          groups.push({name:"DTM",ids:setToArr(dtmGeomOnly)});
        }

        // Resistivity grouped by basename
        const map=new Map();
        resNodes.forEach(n=>{
          const base=n.name.replace(/_\d+$/,"");
          const g=collectGeom(n);
          if(!map.has(base)) map.set(base,new Set());
          g.forEach(v=>map.get(base).add(v));
        });
        [...map.entries()].forEach(([name,ids])=>{
          groups.push({name:name,ids:setToArr(ids)});
        });

        groups.sort((a,b)=>a.name.localeCompare(b.name));

        buildList();
      });
    });
  },
  error:function(){
    statusEl.textContent="Errore Viewer ❌";
  }
});
</script>

</body>
</html>
