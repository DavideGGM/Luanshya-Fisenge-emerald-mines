<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LUANSHYA — Show/Hide (DTM geometrie only)</title>

<script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

<style>
  body{margin:0;height:100vh;display:grid;grid-template-columns:520px 1fr;font-family:system-ui,sans-serif;}
  #left{border-right:1px solid #ddd;padding:12px;overflow:auto;}
  #api-frame{width:100%;height:100%;border:0;}
  .topline{display:flex;align-items:baseline;justify-content:space-between;gap:10px;}
  #status{font-size:13px;opacity:.75;}
  .topbar{display:flex;gap:8px;margin:10px 0 12px;}
  .topbar button{flex:1;padding:10px;cursor:pointer;}
  .row{display:grid;grid-template-columns:1fr 95px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0;}
  .name{font-size:13px;line-height:1.2;}
  .id{font-size:11px;opacity:.6;margin-top:2px;}
  .toggle{padding:8px 10px;font-weight:800;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;}
  .toggle.off{opacity:.55;}
  .disabled{opacity:.45;}
</style>
</head>

<body>
  <div id="left">
    <div class="topline">
      <b>Elementi del modello</b>
      <div id="status">Inizializzo…</div>
    </div>

    <div class="topbar">
      <button id="showAll" disabled class="disabled">Mostra tutto</button>
      <button id="hideAll" disabled class="disabled">Nascondi tutto</button>
    </div>

    <div id="list"></div>
  </div>

  <iframe id="api-frame"
    title="LUANSHYA"
    frameborder="0"
    allowfullscreen
    mozallowfullscreen="true"
    webkitallowfullscreen="true"
    allow="autoplay; fullscreen; xr-spatial-tracking"
    xr-spatial-tracking
    execution-while-out-of-viewport
    execution-while-not-rendered
    web-share
    src="https://sketchfab.com/models/8a3b7c65c4d6495ba888a91ca768555d/embed?annotations_visible=1">
  </iframe>

<script>
  const MODEL_UID = "8a3b7c65c4d6495ba888a91ca768555d";

  const iframe = document.getElementById("api-frame");
  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");
  const btnShowAll = document.getElementById("showAll");
  const btnHideAll = document.getElementById("hideAll");

  const client = new Sketchfab(iframe);
  let apiRef = null;

  // gruppi: {name, ids[], note}
  let groups = [];
  const groupVisible = new Map();

  function enableControls(ok){
    btnShowAll.disabled = !ok;
    btnHideAll.disabled = !ok;
    btnShowAll.classList.toggle("disabled", !ok);
    btnHideAll.classList.toggle("disabled", !ok);
  }

  function safeName(n){
    const nm = (n && n.name ? String(n.name) : "").trim();
    return nm || null;
  }

  function baseName(name){
    return name.replace(/_\d+$/, "");
  }

  function setGroupState(name, isVisible, btnEl){
    groupVisible.set(name, isVisible);
    if(isVisible){ btnEl.textContent="ON"; btnEl.classList.remove("off"); }
    else{ btnEl.textContent="OFF"; btnEl.classList.add("off"); }
  }

  function applyIds(ids, makeVisible){
    for(const id of ids){
      if(makeVisible) apiRef.show(id);
      else apiRef.hide(id);
    }
  }

  function buildList(){
    listEl.innerHTML = "";
    groups.forEach(g=>{
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.groupname = g.name;

      const left = document.createElement("div");
      left.className = "name";
      left.innerHTML =
        `<div>${g.name}</div>` +
        `<div class="id">geometrie: ${g.ids.length}${g.note ? " — " + g.note : ""}</div>`;

      const btn = document.createElement("button");
      btn.className = "toggle";
      btn.onclick = ()=>{
        const isVis = groupVisible.get(g.name) ?? true;
        applyIds(g.ids, !isVis);
        setGroupState(g.name, !isVis, btn);
      };

      setGroupState(g.name, true, btn);

      row.appendChild(left);
      row.appendChild(btn);
      listEl.appendChild(row);
    });

    statusEl.textContent = `Viewer pronto ✅ — gruppi: ${groups.length}`;
    enableControls(true);
  }

  function showAll(){
    groups.forEach(g => applyIds(g.ids, true));
    document.querySelectorAll(".row").forEach(row=>{
      const name = row.dataset.groupname;
      const btn = row.querySelector(".toggle");
      if(btn) setGroupState(name, true, btn);
    });
  }

  function hideAll(){
    groups.forEach(g => applyIds(g.ids, false));
    document.querySelectorAll(".row").forEach(row=>{
      const name = row.dataset.groupname;
      const btn = row.querySelector(".toggle");
      if(btn) setGroupState(name, false, btn);
    });
  }

  btnShowAll.onclick = showAll;
  btnHideAll.onclick = hideAll;

  // ===== SceneGraph traversal =====
  function walk(node, fn){
    if(!node) return;
    fn(node);
    const kids = node.children || [];
    for(const c of kids) walk(c, fn);
  }

  function isGeometryNode(node){
    // in Sketchfab sceneGraph spesso i geometry hanno type che contiene "Geometry"
    const t = String(node.type || "").toLowerCase();
    return t.includes("geometry");
  }

  function collectGeometryIDsUnder(node){
    const ids = new Set();
    walk(node, (n)=>{
      if(isGeometryNode(n) && typeof n.instanceID !== "undefined"){
        ids.add(n.instanceID);
      }
    });
    return ids;
  }

  function findNodesByBaseName(scene, exactBaseName){
    const out = [];
    walk(scene, (n)=>{
      const nm = safeName(n);
      if(!nm) return;
      if(baseName(nm) === exactBaseName) out.push(n);
    });
    return out;
  }

  function findNodesByPrefix(scene, prefix){
    const out = [];
    walk(scene, (n)=>{
      const nm = safeName(n);
      if(!nm) return;
      if(nm.startsWith(prefix)) out.push(n);
    });
    return out;
  }

  function setToArray(set){
    return [...set];
  }

  function unionSets(sets){
    const u = new Set();
    for(const s of sets) for(const v of s) u.add(v);
    return u;
  }

  function difference(a, b){
    const out = new Set();
    for(const v of a) if(!b.has(v)) out.add(v);
    return out;
  }

  function buildGroupsFromSceneGraph(scene){
    // 1) Resistivity: unisci tutte le geometrie sotto i nodi "Resistivity - ..."
    const resistNodes = findNodesByPrefix(scene, "Resistivity");
    const resistGeomSets = resistNodes.map(n => collectGeometryIDsUnder(n));
    const resistGeom = unionSets(resistGeomSets);

    // 2) DTM branch: prova prima "DTM_21" (se esiste), altrimenti "DTM"
    const dtm21Nodes = findNodesByBaseName(scene, "DTM_21");
    const dtmNodes   = findNodesByBaseName(scene, "DTM");

    const dtmRootNodes = dtm21Nodes.length ? dtm21Nodes : dtmNodes;
    const dtmGeomSets  = dtmRootNodes.map(n => collectGeometryIDsUnder(n));
    const dtmGeomAll   = unionSets(dtmGeomSets);

    // 3) DTM “safe”: togli tutte le geometrie che appartengono alle resistivity
    const dtmGeomOnly = difference(dtmGeomAll, resistGeom);

    console.log("Resistivity nodes:", resistNodes.length, "geom:", resistGeom.size);
    console.log("DTM root candidates:", dtmRootNodes.map(n=>n.name), "DTM geom(all):", dtmGeomAll.size);
    console.log("DTM geom(only terrain):", dtmGeomOnly.size);

    // 4) Costruisci gruppi UI
    const groups = [];

    // DTM (safe)
    if(dtmGeomOnly.size){
      groups.push({
        name: "DTM",
        ids: setToArray(dtmGeomOnly),
        note: "solo geometrie terreno (non spegne tutto)"
      });
    } else {
      groups.push({
        name: "DTM",
        ids: [],
        note: "DTM geometrie non trovate (vedi console)"
      });
    }

    // Resistivity groups: raggruppa per baseName e usa geometrie leaf
    // (qui NON usiamo nodeMap: usiamo direttamente sceneGraph)
    const resistByName = new Map(); // baseName -> Set(ids)
    for(const rn of resistNodes){
      const nm = safeName(rn);
      if(!nm) continue;
      const b = baseName(nm);
      const geom = collectGeometryIDsUnder(rn);
      if(!resistByName.has(b)) resistByName.set(b, new Set());
      for(const id of geom) resistByName.get(b).add(id);
    }

    const resistGroups = [...resistByName.entries()]
      .map(([name, idsSet]) => ({ name, ids: setToArray(idsSet), note: "" }))
      .sort((a,b)=>a.name.localeCompare(b.name));

    groups.push(...resistGroups);

    return groups;
  }

  // ===== Init viewer =====
  enableControls(false);

  client.init(MODEL_UID, {
    autostart: 1,
    preload: 1,

    success: function(api){
      apiRef = api;

      api.addEventListener("viewerready", function(){
        statusEl.textContent = "Viewer pronto ✅ — leggo scene graph…";

        api.getSceneGraph(function(err, scene){
          if(err){
            console.error("getSceneGraph error:", err);
            statusEl.textContent = "Errore getSceneGraph ❌ (vedi console)";
            return;
          }

          console.log("SceneGraph:", scene);

          groups = buildGroupsFromSceneGraph(scene);
          buildList();
        });
      });
    },

    error: function(){
      statusEl.textContent = "Errore inizializzazione viewer ❌";
      console.error("Sketchfab Viewer API init error");
    }
  });
</script>
</body>
</html>
